---
title: "Modelling the effect of interventions on COVID-19 in Victoria"
subtitle: ETC5512 Assignment 4, Master of Business Analytics
bibliography: references.bib
author: Arindom Baruah, 32779267, abar0090@student.monash.edu
date: '`r Sys.Date()`'
output:
  bookdown::html_document2:
    biblio-style: "apalike"
    link-citations: true
    css: monashreport.css
    includes:
      before_body: header.html
---

```{css, echo=FALSE}
.watch-out {
  background-color: lightgray;
  border: 3px solid black;
  font-weight: bold;
  
}
```



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  class.source='watch-out'
)
```




```{r libraries}
library(tidyverse)
library(here)
library(ggplot2)
library(ggthemes)
library(ggthemes)
library(bookdown)
library(stringr)
library(DT)
library(kableExtra)
library(deSolve)
```



```{r data_sourcing}
df1 <- read_csv(here::here("data/NCOV_cases_by_agegroup.csv"))
df2 <- read_csv(here::here("data/NCOV_cases_by_postcode_LGA.csv"))
```

# Data sources

1. The dataset pertaining to the COVID-19 cases for the current study is obtained from the official data source of COVID-19 cases curated by the [Victorian Government](https://www.coronavirus.vic.gov.au). This particular dataset contains all the reported cases in the state of Victoria between the time period of January 2020 to June 2022 and can be found in the __[data download](https://www.coronavirus.vic.gov.au/victorian-coronavirus-covid-19-data)__ section. The dataset contains the __diagnosis date, geographical origin of the infection case and the number of cases observed for the particular day__. Moreover, the dataset has a __long format__ which aids the __temporal analysis and modeling__ that will be carried out in the current study. Due to the __authenticity of the dataset__ due to it being released by the Victorian Government directly as well as the __tidy format of the data__, this dataset is ideal for the current analysis.

2. The COVID-19 cases dataset released by Victorian Government is a type of __observational dataset__ as:

   - The dataset contains observations of COVID-19 incidences observed over a period of time in the state of Victoria.
   - The independent variables in the dataset are __not artificially or intentionally placed in specific units__ for the purpose of a study.
   - There is no scenario where only a specific group of people who are exposed to the virus are studied against the rest of the people who are not exposed to the virus which would have suggested an experimental data.
   - There is __no certain scientific claim__ that is expected to be validated using this dataset, as is usually the case for experimental data.
 
3. Codebook for the current dataset can be referred to in the submitted list of files __within the "data" folder__.
   
4. The unit of this current dataset is __the number of positive diagnosis cases__. This unit represents the number of confirmed COVID-19 cases in a particular geographical region or time frame. It contains daily positive cases broken down into the __type of COVID test, data of diagnosis and the geographical region where the case was detected__.
Some of the variables which could act as unique identifiers for the COVID-19 dataset are __diagnosis data,age group,post code and the total case count__. For the days with a single observed case in any of the locations (postal code) and age group, a person maybe uniquely identified. 

5. The Victorian Government website contains the COVID-19 information on the number of cases for each local government area and age groups as __separate datasets__. Ideally, we would want the __geographical and demographical data to be stored within one single dataset__ so that we can analyse where were the restrictions enforced and which group of people were affected by these restrictions.

Following were the data wrangling steps applied to obtain the finalized dataset:

- Datasets of COVID-19 cases __granulated by local government areas and age groups__ are considered for creation of the required dataset.
- Remove unnecessary string characters such as "_" in agegroup column.
- Transform the agegroup dataframe from the long format to a wide format.
- Perform a join between the local government area and the agegroup dataset on the diagnosis date.

Table \@ref(tab:datasetjoin) illustrates the new dataset created after joining the two dataframes.

```{r datasetjoin}

df1$agegroup <- str_replace(df1$agegroup,"_","")
df1_wide <- pivot_wider(data=df1, id_cols = diagnosis_date,
                        names_from = agegroup, values_from = Total_case_count)

ordered_cols <- c("diagnosis_date","0-9","10-19","20-29",
                  "30-39","40-49","50-59",
                  "60-69","70-79","80-89","90+","NA" )

df1_wide <- df1_wide[,ordered_cols]

df_combined <- df2 %>% left_join(df1_wide, by ="diagnosis_date") %>% arrange(diagnosis_date)

head(df_combined) %>%
kable(caption = 'Mean economic statistics of Melbourne electorate based on 2021 Census data',booktabs = TRUE) %>% 
  kable_styling(bootstrap_options = c("bordered","hover")) %>%
  row_spec(0,background="rgb(172,175,145)",color='black',font_size = 18,align = 'c')


```



# üîç Analysis

## <u> Daily cases observed </u>

```{r caseplot, fig.cap="Cases observed per day",fig.align='center',include=TRUE}

start_date <- ymd("2020/06/01") #Start date of analysis
end_date <- ymd("2020/09/13") #End date of analysis
local_ld <- ymd("2020/06/30") #Local lockdown initiates
face_mask <- ymd("2020/07/27") # Mandatory facemasks

plot_interval <- interval(start_date, end_date)

df_combined <- df_combined %>% filter(diagnosis_date %within% plot_interval) %>% mutate(Cumulative_case_count = cumsum(Total_case_count))

df_daily <- df_combined %>% filter(diagnosis_date %within% plot_interval) %>% group_by(diagnosis_date)  %>% summarise(Cases_per_day = sum(Total_case_count))


pl1 <- ggplot(data = df_daily,
              aes(x = diagnosis_date,
                  y = Cases_per_day)) +
  geom_line() + theme_clean() +
  labs(x = "Diagnosis date", y = " Total cases per day") +
  ggtitle("Cases observed per day in 2020") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title = element_text(face = 'bold')) +
  annotate("segment",x = local_ld,
    xend = local_ld,y = 0,
    yend = 700,colour = "red",
    linetype = 1,size = 2
  ) +
  annotate("segment",x = local_ld - days(6),
    y = 500,xend = local_ld ,
    yend = 400 ,arrow = arrow(type = "closed", 
                              length = unit(0.02, "npc"))
  ) +
  annotate("text",x = local_ld - days(15),
    y = 520,colour = "black",
    label = 'Lockdowns implemented \n from 30/06/2020',size = unit(3, "pt")
  ) +
  annotate("segment",x = face_mask,
    xend = face_mask,y = 0,
    yend = 700,colour = "blue",
    linetype = 1,size = 2
  ) +
  annotate("segment",x = face_mask - days(6),
    y = 500,xend = face_mask ,
    yend = 400 ,arrow = arrow(type = "closed", length = unit(0.02, "npc"))
  ) +
  annotate("text",x = face_mask - days(12),
    y = 530,colour = "black",
    label = 'Mandatory facemasks \n from 27/07/2020',size = unit(3, "pt")
  )
pl1


```


```{r avgratecalc}
df_rate <- df_daily %>%
  mutate(
    growth_rate = slider::slide_dbl(
      .x = Cases_per_day,
      .f = mean,
      .before = 6,
      .after = 0
    )
  )
```

```{r avgrateplot,fig.cap="7-day average rise of cases observed per day",fig.align='center',include=TRUE }

pl2 <- ggplot(data = df_rate,
              aes(x = diagnosis_date,
                  y = growth_rate)) +
  geom_line(size=1.5) + theme_clean() +
  labs(x = "Diagnosis date", y = "Total cases per day") +
  ggtitle("7-day rolling average of cases per day \n in 2020") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title = element_text(face = 'bold')) +
  annotate("segment",x = local_ld,
    xend = local_ld,y = 0,
    yend = 700,colour = "red",
    linetype = 1,size = 2) +
  annotate("segment",x = local_ld - days(6),
    y = 500,xend = local_ld ,
    yend = 400 ,arrow = arrow(type = "closed", length = unit(0.02, "npc"))) +
  annotate("text",x = local_ld - days(15),y = 520,
    colour = "black",label = 'Lockdowns implemented \n from 30/06/2020',size = unit(3, "pt")) +
  annotate("segment",x = face_mask,xend = face_mask,
    y = 0,yend = 700,colour = "blue",linetype = 1,size = 2) +
  annotate("segment",x = face_mask - days(6),y = 500,
    xend = face_mask ,yend = 400 ,arrow = arrow(type = "closed", length = unit(0.02, "npc"))) +
  annotate("text",x = face_mask - days(12),y = 530,colour = "black",
    label = 'Mandatory facemasks \n from 27/07/2020',
    size = unit(3, "pt")
  )
pl2

```
As we can observe,the primary difference between the figures \@ref(fig:caseplot) and \@ref(fig:avgrateplot) is the smoothness of the lineplot. As we are using a 7-day mean growth rate instead of the actual daily cases, __the sudden spikes in the number of cases as a result of the peaks and troughs were greatly reduced__. This aids the __interpretability__ of the plot and allows for __better insights.__ 


## <u> 7-day growth rate of cases </u>

```{r growthrateplot,fig.cap="Growth rate of cases within the analysis period",fig.align='center'}

date_interval <- interval(start = start_date,end = end_date)
df_growth_rate <- df_combined %>%
  filter(diagnosis_date %within% date_interval) %>% #Restrict to the second wave
  group_by(diagnosis_date) %>%
  summarise(n=n()) %>%
  mutate(
    growth_rate=slider::slide_dbl(
      .x = n,
.f = function(v) {
log(v[7]/v[1]) / 7 #Seven-day growth rate
      },
      .before=8, #Only look into the past
      .after = 0
) )

pl3 <- ggplot(data=df_growth_rate,aes(x=diagnosis_date,y=growth_rate)) +
  geom_line() + theme_clean() +
  labs(x = "Diagnosis date", y = "Growth rate") +
  ggtitle("7-day growth rate of cases \n in 2020") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title = element_text(face = 'bold')) + geom_smooth(color='darkgreen') +
    annotate("segment",x = local_ld,
    xend = local_ld,y = -0.1,
    yend = 0.3,colour = "red",
    linetype = 1,size = 2) +
  annotate("segment",x = local_ld - days(6),
    y = 0.3,xend = local_ld ,
    yend = 0.25 ,arrow = arrow(type = "closed", length = unit(0.02, "npc"))) +
  annotate("text",x = local_ld - days(15),y = 0.32,
    colour = "black",label = 'Lockdowns implemented \n from 30/06/2020',size = unit(3, "pt")) +
  annotate("segment",x = face_mask,xend = face_mask,
    y = -0.1,yend = 0.3,colour = "blue",linetype = 1,size = 2) +
  annotate("segment",x = face_mask - days(6),y = 0.3,
    xend = face_mask ,yend = 0.25 ,arrow = arrow(type = "closed", length = unit(0.02, "npc"))) +
  annotate("text",x = face_mask - days(12),y = 0.33,colour = "black",
    label = 'Mandatory facemasks \n from 27/07/2020',
    size = unit(3, "pt"))

  
pl3
```



Based on the 7-day growth rate of cases in 2020 as depicted by figure \@ref(fig:growthrateplot), following are the key observations:

- There was a __rising trend of cases__ between the start of the analysis period to the first intervention (lockdown implementation from `r local_ld`).
- After the implementation of the first intervention which are the local lockdowns from `r local_ld`, there was a __drop in the growth rate observed__.
- After the implementation of the second intervention which is the mandatory facemasks from `r face_mask`, soon after the __growth rate dropped below 0__ as a result of which, the __overall positive cases started to drop__.

## <u> Relation between growth rate and effective transmission number </u>


### Part A

The growth rate $g$ and the effective transmission number $R(t)$ are very closely related to each other. To understand this relation, we can interpret $R(t)$ by its statistical effect on the population. The effective transmission number $R(t)$ indicates that __on average, how many people may be infected when an infectious person comes in contact with them__.

- For __$R(t)$ > 1__, on average, each infectious person infects more than one person __leading to an exponential growth of cases__.\
- For __$R(t)$ = 1__, on average, each infectious person infects one person. __Under such a circumstance, the daily cases start stagnating and flattening.__ \
- For __$R(t)$ < 1__, on average, each infectious person infects less than one person __leading to an exponential drop of cases__. \

The value of $R(t)$ can be __significantly altered through interventions such as lockdowns, facemasks and vaccinations__. Hence, the growth rate of cases are accordingly observed to rise or fall with the change in $R(t)$.


### Part B {#label1}

The relation between the growth rate $g$ and the effective transmission number $R(t)$ in the given equation is dependent on each other through the average infectious period $T$. This equation gives us an estimation of the growth rate of cases.

The important thresholds which allow us to understand the current state of the disease are as follows :

- If __$g > 0$__, the epidemic undergoes an __exponential rise in daily cases__. \
- If __$g = 0$__, the number of cases start __stagnating and the daily case plot start flattening__. \
- If __$g < 0$__, the epidemic undergoes an __exponential drop in daily cases__. \

On the other hand, the relation between the growth rate $g$ and the effective transmission number $R(t)$ as observed in class gives us an __estimate of the effective transmission number $R(t)$__. The equation is based on the assumption that there is no variance in the generation time(or average infectious period). The same equation based on the nomenclature provided here can be written as follows. 

$\boxed{R(t) =  e^{gT}}$ 

The thresholds for the above equation are as follows:

- For __$R(t)$ > 1__, on average, each infectious person infects more than one person __leading to an exponential growth of cases__.\
- For __$R(t)$ = 1__, on average, each infectious person infects one person. __Under such a circumstance, the daily cases start stagnating and flattening.__ \
- For __$R(t)$ < 1__, on average, each infectious person infects less than one person __leading to an exponential drop of cases__. \

## <u> Infectious disease modeling using the S.E.I.R. model </u>

### Population compartmentalization

In epidemiology, an infectious disease maybe modeled by a set of specific assumptions and the result of ordinary differential equations. These models are termed as compartmental models as they are used to divide the entire population into specific compartments. \

In any infectious disease modeling, it is extremely important to __estimate the delay of infection notification__. Based on the study by @lauer2020qifang , __the incubation period__, which is the delay between the inoculation (contact with virus) and symptoms is __approximately 5 days__. Additionally, based on the information by the __Department of Health and Human Services (DHHS) Victoria__, it may [take around 1-3 days](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwjJl7bM7Jz_AhUngFYBHTBvAHQQFnoECAkQAw&url=https%3A%2F%2Fwww.dhhs.vic.gov.au%2Ftesting-coronavirus-english-accessible%23%3A~%3Atext%3DHow%2520long%2520does%2520it%2520take%2Chospital%2520where%2520you%2520got%2520tested.&usg=AOvVaw2RTE4ImgWjp0s3mWv-RXjN) to get an outcome of the result.

As a result, a close estimation of the delay in notification of a positive case can significantly aid the accurate modeling of the infectious disease. The S.E.I.R model attempts to do so by compartmentalizing the total population into the following four groups :

- __S (Symptomatic)__ : Susceptible people, those who can be infected. \
- __E (Exposed)__ : Individuals who are infected but not infectious at the moment. \
- __I (Infection)__ : Infected and infectious people, those who have got and can spread the virus. \
- __R (Recovered)__ : People who have recovered and cannot infect further. Consequently, they don't participate in the dynamics any further. \


### Intervention incorporation in the S.E.I.R. model

Using the S.E.I.R. model, the reproduction number, $R(o)$ helps us understand the average number of secondary infections produced by a typical infectious individual __in a completely susceptible population__. The threshold for $R(o)$ and $R_{eff}$ provide us similar insights which have been delineated in section \@ref(label1).

In order to understand how the value of $R(o)$ changes for various interventions, we can divide the time period of analysis into the following segments:

- Phase 1 : __No intervention period__ from `r start_date` to `r local_ld`.
- Phase 2 : __Initial intervention (Lockdowns)__ from `r local_ld` to `r face_mask`
- Phase 3 : __Additional intervention (Lockdowns + Facemasks)__ from `r face_mask` to `r end_date`.

To understand the effect of the interventions on the spread of the disease, $R(o)$ for __each of above timeline phases will be calculated and compared to each other__ to observe how the disease spread varied.

## <u> Ordinary Differential Equation for solving the model </u>

```{r ode, message=F, eval=T}


COVID_uncontrolled <- function(t, state, parameters) {
  with(as.list(c(state, parameters)), { # Let's us refer to named objects without square brackets
    N <- S + E + I + R # Total population size
    dSdt <- -beta * S * I / N
    dEdt <- beta * S * I / N - sigma * E
    dIdt <- sigma * E - gamma * I
    dRdt <- gamma * I
    dIncidencedt <- sigma * E
    return(list(
      c(dSdt, dEdt, dIdt, dRdt, dIncidencedt) 
    ))
  })
}
```



## <u> Initial parameter selection and solution </u>

Following are the initial guess parameters to be applied to the model:

- $\beta = \frac36$ \
- $\sigma = \frac1{10}$ \
- $\gamma - \frac13$ \
- Initial infected cases = 20
- Population of Victoria = 6.681 Million

```{r initialize-params}

solve_times <- seq(int_start(date_interval), int_end(date_interval), by = "1 day")

parameters <- c(
  "beta" = 3/6,
  "sigma" = 1 / 10,
  "gamma" = 1 / 3 # Gives an R0 (beta/gamma) of 1.5
)

N <- 6.681e6 #Population of Victoria
initial_infected <- 20
initial_state <-
  c("S" = N - initial_infected,
    "E" = 0,
    "I" = initial_infected,
    "R" = 0,
    "incidence" = 0)


tidy_model <- function(ode_output, start_date) {
  as_tibble(ode_output) %>%
    mutate(
      date = as.Date(start_date + days(time)),
      daily_incidence = c(0, diff(incidence))
    )
}
```

Based on the above initial parameters, the following code-chunk contains the solution of the ordinary differential equation to calculate the predicted number of diagnosed cases. Table \@ref(tab:odeoutput) lists out the initial rows of the output datafram while figure \@ref(fig:fitact) depicts the comparison between the actual number of cases and the modeled number of cases using the S.E.I.R. model with the initial chosen parameters. 

```{r odeoutput}

out_init <- ode(
   y = initial_state,
   times = as.numeric(difftime(solve_times, solve_times[1], units = "days")),
   func = COVID_uncontrolled,
   parms = parameters
) 

head(out_init) %>%
kable(caption = 'ODE output',booktabs = TRUE) %>% 
  kable_styling(bootstrap_options = c("bordered","hover")) %>%
  row_spec(0,background="rgb(172,175,145)",color='black',font_size = 18,align = 'c')


tidy_output <- tidy_model(out_init, int_start(date_interval))
```



```{r fitact,fig.cap="Comparison between actual and modelled cases in Victoria",fig.align='center'}
pl4 <- ggplot() + geom_col(data= df_rate %>% filter(diagnosis_date < ymd("20200815")), 
                           aes(x=diagnosis_date,
                               y=Cases_per_day),
                           fill='darkblue') + 
  geom_point(data = tidy_output %>% filter(date < ymd("20200815")),aes(x=date,y=incidence),color='red') + 
  labs(x='Diagnosis date',y='Number of cases') + theme_clean() + ggtitle("Comparison between actual and modelled cases in Victoria") + theme(plot.title = element_text(hjust = 0.5))
pl4
```






```{r}


negative_log_likelihood <- function(transformed_parameters, data, state, times, func, other_parameters) {
  # Untransform parameters:
  beta <- exp(transformed_parameters["R0"]) * other_parameters["gamma"]
  names(beta) <- "beta"

  parameters <- c(beta, other_parameters)
  out_ode <- ode(
    y = state,
    times = as.numeric(difftime(times, times[1], units = "days")),
    func = func,
    parms = parameters
  ) %>%
    tidy_model(start_date = times[1])

  -sum(dpois(
    x = data$Cases_per_day[-1],
    lambda = out_ode$daily_incidence[-1],
    log = TRUE
  ))
}
```





```{r no-intervention, eval=T, include=T}


plot_interval <- interval(start_date, local_ld) #Time interval for no interventions

solve_times <- seq(int_start(plot_interval), int_end(plot_interval), by = "1 day")
initial_transformed_parameters <- log(c("R0" = 2))


optimum_mle <- optim(
  par = initial_transformed_parameters,
  fn = negative_log_likelihood,
  data = df_rate,
  state = initial_state,
  times = solve_times,
  func = COVID_uncontrolled,
  other_parameters = c(parameters["gamma"], parameters["sigma"])
)

optimum_mle
```


```{r first-intervention}


plot_interval <- interval(local_ld, face_mask) #Time interval for first set of interventions

solve_times <- seq(int_start(plot_interval), int_end(plot_interval), by = "1 day")
initial_transformed_parameters <- log(c("R0" = 2))


optimum_mle <- optim(
  par = initial_transformed_parameters,
  fn = negative_log_likelihood,
  data = df_rate,
  state = initial_state,
  times = solve_times,
  func = COVID_uncontrolled,
  other_parameters = c(parameters["gamma"], parameters["sigma"])
)

optimum_mle
```

```{r second-intervention}

plot_interval <- interval(face_mask, end_date) #Time interval for second set of interventions

solve_times <- seq(int_start(plot_interval), int_end(plot_interval), by = "1 day")
initial_transformed_parameters <- log(c("R0" = 2))


optimum_mle <- optim(
  par = initial_transformed_parameters,
  fn = negative_log_likelihood,
  data = df_rate,
  state = initial_state,
  times = solve_times,
  func = COVID_uncontrolled,
  other_parameters = c(parameters["gamma"], parameters["sigma"])
)

optimum_mle

```


# üìâ Data curation


# Resources

Cite your data sources, and software used here. 


